<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ktdsuniversity.edu.board.dao.impl.BoardDaoImpl">

<!-- Join 된 쿼리의 결과를 단일 인스턴스로 받을 수 있도록 해준다  -->
<resultMap type="com.ktdsuniversity.edu.board.vo.BoardVO"
           id="BoardVOMap"
           autoMapping="true">
           <id column="ID" property="id" />
           <association property="fileGroupVO"
                        javaType="com.ktdsuniversity.edu.file.vo.FileGroupVO"
                        autoMapping="true">
                        <id column="FILE_GROUP_ID" property="fileGroupId"/>
                        <collection property="fileVO"
                                    javaType="list"
                                    ofType="com.ktdsuniversity.edu.file.vo.FileVO"
                                    autoMapping="true">
                                    <id column="FILE_ID" property="fileId"/>
                        </collection>
           </association>
</resultMap>
  <select id="selectBoardOneDao"
          parameterType = "java.lang.String"
          resultMap="BoardVOMap">
			SELECT   B.ID
			       , B.SUBJECT
			       , B.CONTENT
			       , B.EMAIL
			       , B.VIEW_CNT
			       , B.CRT_DT
			       , B.MDFY_DT
			       , B.DEL_YN
			       , F.FILE_GROUP_ID 
			       , F.FILE_COUNT 
			       , F.FILE_ID 
			       , F.FILE_DISPLAY_NAME 
			       , F.FILE_SIZE 
			       , F.FILE_TYPE 
			  FROM BOARD B
			  LEFT OUTER JOIN ( SELECT FG.FILE_GROUP_ID 
			                         , FG.FILE_COUNT 
			                         , F.FILE_ID 
			                         , F.FILE_DISPLAY_NAME 
			                         , F.FILE_SIZE 
			                         , F.FILE_TYPE 
			                      FROM FILE_GROUP FG
			                     INNER JOIN "FILE" f
			                        ON FG.FILE_GROUP_ID = F.FILE_GROUP_ID ) F
			    ON B.FILE_GROUP_ID = F.FILE_GROUP_ID 
			 WHERE B.ID = #{_parameter}
			   AND B.DEL_YN = 'N' 
  </select>
  <select id="selectBoardList"
  resultType="com.ktdsuniversity.edu.board.vo.BoardVO">
  SELECT ROW_NUMBER() OVER(ORDER BY ID)AS "NUMBER"
       , ID
       , SUBJECT
       , CONTENT
       , EMAIL
       , VIEW_CNT
       , TO_CHAR(CRT_DT, 'YYYY-MM-DD') AS CRT_DT
       , TO_CHAR(MDFY_DT, 'YYYY-MM-DD') AS MDFY_DT
       , MDFY_DT
       , DEL_YN
    FROM BOARD 
   WHERE DEL_YN ='N'
   ORDER BY "NUMBER" DESC
  </select>
  <select id="selectBoardListCount"
  resultType="int">
    SELECT COUNT(id)
      FROM BOARD
  </select>
  <insert id ="writeBoard"
  parameterType="com.ktdsuniversity.edu.board.vo.RequestCreateBoardVO">
     <selectKey resultType="string" keyProperty="id" order="BEFORE">
        SELECT 'AR-' || TO_CHAR(SYSDATE, 'YYYYMMDD-') || LPAD(SEQ_BOARD_PK.NEXTVAL,6,'0')
        FROM DUAL
      </selectKey>
  INSERT INTO SPRING_BOOT.BOARD
			 ( ID
			 , SUBJECT
			 , CONTENT
			 , EMAIL
			 , VIEW_CNT
			 , CRT_DT
			 , MDFY_DT
			 , DEL_YN
			 , FILE_GROUP_ID)
	   VALUES
			 ( #{id}
			 , #{subject}
			 , #{content}
			 , #{email}
			 , 0
			 , SYSDATE
			 , SYSDATE
			 , 'N'
			 , #{fileGroupId})
  </insert>
  <update id="updateViewCountUp"
  parameterType = "string">
	  UPDATE BOARD 
	     SET VIEW_CNT = VIEW_CNT + 1
	   WHERE ID = #{_parameter}
  </update>
  
  <update id="updateModify"
  parameterType="com.ktdsuniversity.edu.board.vo.RequestCreateBoardVO">
  UPDATE BOARD
     SET SUBJECT = #{subject}
       , EMAIL = #{email}
       , CONTENT = #{content}
   WHERE ID = #{id}
  </update>
  
   <update id="updateDelete"
  parameterType = "string">
      UPDATE BOARD 
         SET DEL_YN = 'Y'
       WHERE ID = #{_parameter}
  </update>
  
</mapper>